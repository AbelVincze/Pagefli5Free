<?php class pdfparser{private $log="";private $showobjs=true;private $logtofile;private $logfile;private $temparr;private $pdfdata;function __construct($logfile=null){if($logfile){$this->logtofile=true;$this->logfile=$logfile;}}function __destruct(){}public function parsepdf($pdffile){$this->pdfdata=$this->pdfparser($pdffile);return $this->pdfdata;}private function pdfparser($pdffile){$maxlinks=0;$pagelinks=0;$urllinks=0;$spreads=0;$rotatedpages=0;$pageorder=array();$objarray=$this->getpdfobjects($pdffile);if(count($objarray)==0)return false;$catalog=$this->findfirstobjwithattr($objarray,"type/catalog");if($catalog===false)$catalog=$this->findfirstobjwithattr($objarray,"type /catalog");if($catalog===false){return false;}$pagesroot=$this->getr($objarray[$catalog],"pages");if($objarray[$pagesroot]){$maxpage=$this->getv($objarray[$pagesroot],"count");$defmediabox=$this->getvarray($objarray[$pagesroot],"mediabox");$defbleedbox=$this->getvarray($objarray[$pagesroot],"bleedbox");$pageorder=$this->getpageorderfrompagesroot($objarray,$pagesroot);if($pageorder===false){return false;}else{}if(count($pageorder)!=$maxpage){$maxpage=count($pageorder);}else{}}else{$pages=$this->findallpage($objarray);$maxpage=count($pages);foreach($pages as $objcode){$i=$this->getv($objarray[$objcode],"structparents");if($i===false)break;$pageorder[intval($i)]=$objcode;}if(count($pageorder)!=$maxpage){return false;}else{}}$realpagenumbers=array();for($i=0;$i<count($pageorder);$i++){$realpagenumbers[$pageorder[$i]]=$i;}$pdfdata=array();$pdfdata["pages"]=array();$constpagesize=1;for($i=0;$i<count($pageorder);$i++){$pagedata=array();if(isset($objarray[$pageorder[$i]])){$prop=$objarray[$pageorder[$i]];$mediabox=$this->getvarray($prop,"mediabox");$bleedbox=$this->getvarray($prop,"bleedbox");if($i==0&&$mediabox)$defmediabox=$mediabox;if($i==0&&$bleedbox)$defbleedbox=$bleedbox;if(!$defmediabox&&$mediabox)$defmediabox=$mediabox;if(!$defbleedbox&&$bleedbox)$defbleedbox=$bleedbox;if(!$mediabox&&$defmediabox)$mediabox=$defmediabox;if(!$bleedbox&&$defbleedbox)$bleedbox=$defbleedbox;$pdfrot=$this->getv($prop,"rotate");if($pdfrot=="90"||$pdfrot=="270"){$x=$mediabox[0];$y=$mediabox[1];$w=$mediabox[2];$h=$mediabox[3];$mediabox[0]=$y;$mediabox[1]=$x;$mediabox[2]=$h;$mediabox[3]=$w;$pdfrot=true;}else{$pdfrot=false;}if($mediabox){$pagedata["mediabox"]=$mediabox;if($this->isrotated($defmediabox,$mediabox)||$pdfrot){$pagedata["rotated"]=true;$rotatedpages++;}else if($spreadtype=$this->isspread($defmediabox,$mediabox)){$pagedata["spread"]=$spreadtype;$spreads++;}$pagedata["mdpi"]=$this->getdpimultiplier($defmediabox,$mediabox);if(!$this->isalmostsamesize($defmediabox,$mediabox)){$constpagesize=0;}}if($bleedbox){$pagedata["bleedbox"]=$bleedbox;}$annots=$this->getv($prop,"annots");if($annots!==false){if(!$this->isarray($annots))$annots=$this->getarrayfromrarray($objarray[trim(substr($annots,0,-1))]);else $annots=$this->getarrayfromrarray($annots);$pagelinks=array();for($a=0;$a<count($annots);$a++){$annot=$objarray[$annots[$a]];if(strpos($annot,"subtype")!==false&&(strpos($annot,"link")!==false||strpos($annot,"widget")!==false)){$rect=$this->getvarray($annot,"/rect");if($rect===false)continue;$dest=$this->getdestination($objarray,$annot);if($dest){if(isset($dest["page"])&&isset($realpagenumbers[$dest["page"]])){$dest["page"]=$realpagenumbers[$dest["page"]];$pagelinks++;}if(isset($dest["url"])){$urllinks++;}$dest["rect"]=$rect;$pagelinks[]=$dest;$maxlinks++;}}}$pagedata["links"]=$pagelinks;}}$pdfdata["pages"][]=$pagedata;}$maxpage=intval($maxpage);$pdfdata["info"]=array("pagecount"=>$maxpage,"pagelinkcount"=>$pagelinks,"urllinkcount"=>$urllinks,"totallinkcount"=>$maxlinks,"rotatedpagecount"=>$rotatedpages,"spreadcount"=>$spreads,"singlepagecount"=>($maxpage-$spreads)+$spreads*2,"constpagesize"=>$constpagesize);if($defmediabox){$pdfdata["info"]["mediabox"]=$defmediabox;}if($defbleedbox){$pdfdata["info"]["bleedbox"]=$defbleedbox;}return $pdfdata;}private function getpdfobjects($file){ini_set("auto_detect_line_endings",true);if(!file_exists($file))return null;if(!$fp=@fopen($file,"r"))return null;$isstream=false;$isobj=false;$isprop=false;$isroot=false;$bl=4096;$isarray=false;$objcode="";$data="";$objarray=array();$objstmarray=array();while(!feof($fp)){$lines=explode("\r",fgets($fp,$bl));for($subline=0;$subline<count($lines);$subline++){$line=$lines[$subline];$full=(strlen($line)==$bl-1);$line=trim($line);$nl=false;$isroot=false;if($isstream==false){if(!$isobj){$pos=strpos($line,"obj");if($pos!==false){$isobj=true;$objcode=trim(substr($line,0,$pos));$data="";$line=trim(substr($line,$pos+3));}}if(substr($line,0,2)=="<<"){$isprop=true;if(!$isobj)$isroot=true;$line=trim(substr($line,2));}if($isobj){$pos=strpos($line,"stream");if($pos===0||substr($line,-6)=="stream"){$isstream=true;$line=trim(substr($line,0,$pos));if(strpos($line,"ObjStm")!==false){$oss=$this->getv($line,"/First");$osl=$this->getv($line,"/Length");$osf=$this->getnv($line,"/Filter");$osn=$this->getv($line,"/N");$objstm=substr(fread($fp,$osl+1),1);$dobjstm=@gzuncompress($objstm);$osl=strlen($dobjstm);$osdata=substr($dobjstm,0,$oss);$osdata=$this->dataexplode($osdata);for($i=0;$i<count($osdata);$i+=2){$osobj=$osdata[$i]." 0";$osobjlength=isset($osdata[$i+3])?$osdata[$i+3]-$osdata[$i+1]:$osl-$osdata[$i+1];$ossp=$oss+$osdata[$i+1];$osobjdata=substr($dobjstm,$ossp,$osobjlength);$osobjdata=strtolower(trim($osobjdata));if(substr($osobjdata,0,2)=="<<"){$objarray[$osobj]=substr($osobjdata,2,strlen($osobjdata)-4);}else{$objarray[$osobj]=$osobjdata;}}}}if(substr($line,-6)=="endobj"){$isprop=$isobj=false;$line=trim(substr($line,0,-6));$nl=true;}if(!$isarray&&substr($line,0,1)=="["){$isarray=true;}if($isarray&&substr($line,-1)=="]"){$isarray=false;}if(substr($line,-2)==">>"){$isprop=false;$line=trim(substr($line,0,-2));}$data.=$line." ";}else{if($isprop){if(substr($line,-2)==">>"){$isprop=false;$line=trim(substr($line,0,-2));$nl=true;}if($isroot){$objcode="root";$data="";}$data.=$line." ";}}if($nl){$finaldata=strtolower(trim($data));$objarray[$objcode]=$finaldata;}}if(substr($line,-9)=="endstream")$isstream=false;}}fclose($fp);return $objarray;}private function getdestination($objarray,$prop){if($this->isarray($prop)){$dest=$this->getarrayfromrarray($prop)[0];return array("page"=>$dest);}$dest=$this->getvasarray($prop,"dest");if($dest!==false)return $this->getdestination($objarray,$dest);$destobj=$this->getattrobjectvalue($prop,"a");if($destobj===false)$destobj=$objarray[$this->getr($prop,"a ")];if($destobj!==false){$title=$this->getattrstringvalue($destobj,"d");if($title){$tempdest=$this->findobjwithtitle($objarray,$title);if($tempdest){return $this->getdestination($objarray,$objarray[$tempdest]);}$destobj=$this->findobjwithname($objarray,$title);$tempdest=$this->getr($destobj,"d[");if($tempdest===false)$tempdest=$this->getr($destobj,"d [");if($tempdest===false)return $this->getdestination($objarray,$destobj);return array("page"=>$tempdest);}$tempdest=$this->getr($destobj,"d ");if($tempdest===false)$tempdest=$this->getr($destobj,"d[");if($tempdest){$tempprop=$objarray[$tempdest];if($tempprop){if(strpos($tempprop,"page")!==false){return array("page"=>$tempdest);}}return $this->getdestination($objarray,$objarray[$tempdest]);}$url=$this->getattrstringvalue($destobj,"uri");if($url){return array("url"=>$url);}}return false;}private function isarray($prop){if(substr($prop,0,1)=="[")return true;return false;}private function getattrobjectvalue($prop,$attr){$s=$attr."<<";$pos=strpos($prop,$s);if($pos===false){$s=$attr." <<";$pos=strpos($prop,$s);}if($pos!==false){$prop=trim(substr($prop,$pos+strlen($s)));$pos=strpos($prop,">>");if($pos!==false){$prop=trim(substr($prop,0,$pos));}return $prop;}return false;}private function getattrstringvalue($prop,$attr){$s=$attr."(";$pos=strpos($prop,$s);if($pos===false){$s=$attr." (";$pos=strpos($prop,$s);}if($pos!==false){$prop=trim(substr($prop,$pos+strlen($s)));$pos=strpos($prop,")");if($pos!==false){$prop=trim(substr($prop,0,$pos));}return $prop;}return false;}private function getr($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($attr)));$pos=strpos($prop,"/");if($pos!==false){$prop=trim(substr($prop,0,$pos));}if(substr($prop,-1)=="r"){return trim(substr($prop,0,-1));}return false;}return false;}private function getv($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($attr)));$pos=strpos($prop,"/");if($pos!==false){$prop=trim(substr($prop,0,$pos));}return $prop;}return false;}private function getnv($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($attr)));$pos=strpos($prop,"/");if($pos!==false){$prop=trim(substr($prop,$pos+1));$pos=strpos($prop,"/");if($pos!==false){$prop=trim(substr($prop,0,$pos));}return $prop;}}return false;}private function dataexplode($str){$str=trim($str)." ";$out=array();$sep=false;$tmp="";for($p=0;$p<strlen($str);$p++){$c=substr($str,$p,1);if($c==" "){if(!$sep){$out[]=$tmp;$sep=true;$tmp="";}}else{$sep=false;$tmp.=$c;}}return $out;}private function getvarray($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($attr)));if(substr($prop,0,1)=="["){$pos=strpos($prop,"]");if($pos!==false){$values=$this->dataexplode(substr($prop,1,$pos-1));foreach($values as&$val){$val=trim($val);}return $values;}}}return false;}private function getvasarray($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($attr)));if(substr($prop,0,1)=="["){$pos=strpos($prop,"]");if($pos!==false){return trim(substr($prop,0,$pos+1));}}}return false;}private function getrarray($prop,$attr){$pos=strpos($prop,$attr);if($pos!==false){$prop=substr($prop,$pos+strlen($attr));return $this->getarrayfromrarray($prop);}return false;}private function getarrayfromrarray($rarr){$rarr=trim($rarr);if(substr($rarr,0,1)=="["){$pos=strpos($rarr,"]");if($pos!==false){$refs=explode("r",trim(substr($rarr,1,$pos-1)),-1);foreach($refs as&$val){$val=trim($val);}return $refs;}}return false;}private function findfirstobjwithattr($objarray,$attr){foreach($objarray as $objcode=>$prop){$pos=strpos($prop,$attr);if($pos!==false){return $objcode;}}return false;}private function findallpage($objarray){$found=array();foreach($objarray as $objcode=>$prop){$pos=strpos($prop,"type");if($pos!==false){$pos=strpos($prop,"page");if($pos!==false){if(strpos($prop,"pages")===false)$found[]=$objcode;}}}return $found;}private function findobjwithtitle($objarray,$title){foreach($objarray as $objcode=>$prop){$pos=strpos($prop,"title($title)");$pos2=strpos($prop,"title ($title)");if($pos!==false||$pos2!==false){return $objcode;}}return false;}private function findobjwithname($objarray,$title){foreach($objarray as $objcode=>$prop){$pos=strpos($prop,"names");if($pos!==false){$prop=trim(substr($prop,$pos+5));$s="($title)";$pos=strpos($prop,$s);if($pos!==false){$prop=trim(substr($prop,$pos+strlen($s)));$pos=strpos($prop,"r");if($pos!==false){if(substr($prop,0,1)=="["){$dest=trim(substr($prop,1,$pos-1));return"d[$dest r/]";}else{$dest=trim(substr($prop,0,$pos));}if(isset($objarray[$dest]))return $objarray[$dest];return false;}}}}return false;}private function getpageorderfrompagesroot($objarray,$objcode){$this->temparr=array();$refs=$this->getrarray($objarray[$objcode],"kids");$this->getpageobjcodesfromrarray($objarray,$refs);return $this->temparr;}private function getpageobjcodesfromrarray($objarray,$refs){for($i=0;$i<count($refs);$i++){$prop=$objarray[$refs[$i]];$pos=strpos($prop,"/type");if($pos!==false){$pos=strpos($prop,"/pages");if($pos!==false){$subrefs=$this->getrarray($prop,"/kids");if($subrefs!==false){$this->getpageobjcodesfromrarray($objarray,$subrefs);}}else{$pos=strpos($prop,"/page");if($pos!==false){$this->temparr[]=$refs[$i];}}}}}private function arealmostequals($a,$b){$limit=($a+$b)/200;return(abs($a-$b)<$limit);}private function isalmostdouble($a,$b){$limit=$a/100;return(abs($a-$b/2)<$limit);}private function isrotated($defrect,$rect){$defsize=$this->getrectsize($defrect);$size=$this->getrectsize($rect);return(!$this->arealmostequals($defsize["width"],$defsize["height"])&&$this->arealmostequals($defsize["width"],$size["height"])&&$this->arealmostequals($defsize["height"],$size["width"]));}private function isspread($defrect,$rect){$defsize=$this->getrectsize($defrect);$size=$this->getrectsize($rect);$spread=false;if($this->isalmostdouble($defsize["width"],$size["width"])&&$this->arealmostequals($defsize["height"],$size["height"])){$spread="h";}else if($this->isalmostdouble($defsize["height"],$size["height"])&&$this->arealmostequals($defsize["width"],$size["width"])){$spread="v";}return $spread;}private function isalmostsamesize($defrect,$rect){$defsize=$this->getrectsize($defrect);$size=$this->getrectsize($rect);$same=false;if($this->arealmostequals($defsize["width"],$size["width"])&&$this->arealmostequals($defsize["height"],$size["height"])){$same=true;}return $same;}private function getdpimultiplier($defrect,$rect){$defsize=$this->getrectsize($defrect);$size=$this->getrectsize($rect);$wm=$defsize["width"]/$size["width"];$hm=$defsize["height"]/$size["height"];$m=array();$m["Fit"]=($wm<$hm)?$wm:$hm;$m["Fill"]=($wm>$hm)?$wm:$hm;$m["Noscale"]=1;return $m;}public function getinfo(){return $this->pdfdata["info"];}public function getpagecount(){return $this->pdfdata["info"]["pagecount"];}public function getpagemediabox($page){return $this->pdfdata["pages"][$page]["mediabox"];}public function getpagebleedbox($page){return $this->pdfdata["pages"][$page]["bleedbox"];}public function getpdfpages(){return $this->pdfdata["pages"];}public function getpagelinks($page){return $this->pdfdata["pages"][$page]["links"];}public function getpdfdata(){return $this->pdfdata;}public function setpdfdata($pdfdata){$this->pdfdata=$pdfdata;}public function getrectsize($rect){$size=array("left"=>$rect[0],"bottom"=>$rect[1],"width"=>$rect[2]-$rect[0],"height"=>$rect[3]-$rect[1]);return $size;}} ?>